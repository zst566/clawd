# 2026-02-04 - 茂名文旅平台部署修复

## OSS 上传功能修复

### 问题：Bucket 权限错误
- 错误信息：`You have no right to access this object because of bucket acl.`
- 解决方案：用户在阿里云 OSS 控制台为 `hxcm-oss` Bucket 配置了 RAM 授权

### 测试结果
- 上传测试图片：`banner-1.png`
- 上传成功，图片 URL：
  `https://hxcm-oss.oss-cn-shenzhen.aliyuncs.com/banner/1770212227794-0d17306b-5d7b-4db0-8cbb-0bb98968ebcf.png`

---

## PC 端 API 502 错误修复

### 问题 1：nginx 缺少 `/api/pc/` 代理配置
- 原有配置只代理 `/api/mobile/`
- 修复：添加 `location /api/pc/` 代理到 `localhost:3000`

### 问题 2：后端容器不在 Docker 网络中
- 后端容器 `xinyi-wenlu-backend` 未加入 `web-network`
- 修复：`docker network connect web-network xinyi-wenlu-backend`

### 问题 3：数据库表缺失
- 错误：`The table 'systemconfig' does not exist`
- 修复：在容器内执行 `npx prisma db push` 同步数据库

### 问题 4：nginx 语法错误
- 错误：`invalid number of arguments in "proxy_set_header"`
- 原因：变量 `$host` 未转义被清空
- 修复：使用 `\$host` 语法

---

## Docker 网络结构

| 容器名 | IP | 网络 |
|-------|-----|------|
| xinyi-wenlu-backend | 172.19.0.2 | web-network |
| xinyi-wenlu-pc-admin | 172.19.0.4 | web-network |
| xinyi-wenlu-mobile-h5 | 172.19.0.3 | web-network |

---

## 服务访问地址

| 服务 | 地址 | 端口 |
|------|------|------|
| PC 管理端 | http://112.74.36.81:8081 | 8081 |
| 后端 API | http://112.74.36.81:3000 | 3000 |
| 移动端 H5 | http://112.74.36.81:8080 | 8080 |

---

## OSS 配置

- Bucket：`hxcm-oss`
- 地域：`oss-cn-shenzhen-internal`
- AccessKey：LTAI5t83jKH5pYD8o6eAbVmT（已配置 RAM 权限）
- 上传路径：`banner/{timestamp}-{uuid}.png`

---

## 待办

- [ ] 同步 PC 端 nginx 配置到项目代码仓库
- [ ] 更新 deploy 脚本，包含 prisma db push
- [ ] 完善 nginx 配置模板，避免变量转义问题
