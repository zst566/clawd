# å‡†ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŒ‡å—

> æœ¬æ–‡æ¡£è®°å½•å¦‚ä½•ä½¿ç”¨ `ä¸€é”®éƒ¨ç½²-prod.sh` è„šæœ¬å°†æœ¬åœ°ä»£ç éƒ¨ç½²åˆ°å‡†ç”Ÿäº§ç¯å¢ƒæœåŠ¡å™¨

---

## ğŸ“‹ æ¦‚è¿°

å‡†ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²é‡‡ç”¨**ä¸€é”®éƒ¨ç½²è„šæœ¬**ï¼Œè‡ªåŠ¨åŒ–å®Œæˆä»æœ¬åœ°æ„å»ºåˆ°è¿œç¨‹éƒ¨ç½²çš„å…¨æµç¨‹ã€‚

**ç›®æ ‡æœåŠ¡å™¨**: 8.138.192.106ï¼ˆé˜¿é‡Œäº‘ï¼‰  
**è®¿é—®åœ°å€**: https://xiaolu-test.lantel.net  
**éƒ¨ç½²æ–¹å¼**: Docker å®¹å™¨åŒ–éƒ¨ç½²  
**éƒ¨ç½²è„šæœ¬**: `ä¸€é”®éƒ¨ç½²-prod.sh`

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å‰ç½®æ¡ä»¶

| æ£€æŸ¥é¡¹ | è¦æ±‚ | éªŒè¯å‘½ä»¤ |
|--------|------|---------|
| SSH å…å¯†ç™»å½• | å·²é…ç½® `lzy-pre-production` åˆ«å | `ssh lzy-pre-production echo "OK"` |
| Docker | æœ¬åœ°å·²å®‰è£… Docker | `docker --version` |
| é˜¿é‡Œäº‘é•œåƒä»“åº“ | å·²ç™»å½• | `docker info \| grep registry` |
| SSL è¯ä¹¦ | å·²æ”¾ç½®åœ¨ `nginx-ssl-config/ssl/` ç›®å½• | `ls nginx-ssl-config/ssl/` |

### 2. é…ç½® SSH å…å¯†ç™»å½•

```bash
# ç¼–è¾‘ SSH é…ç½®æ–‡ä»¶
vim ~/.ssh/config

# æ·»åŠ ä»¥ä¸‹å†…å®¹
Host lzy-pre-production
    HostName 8.138.192.106
    User root
    IdentityFile ~/.ssh/your_key_file
    StrictHostKeyChecking no
```

### 3. æ‰§è¡Œéƒ¨ç½²

```bash
cd /Volumes/SanDisk2T/dv-codeBase/é¹¿çŠ¶å…ƒ

# æ–¹å¼1: è‡ªåŠ¨ç‰ˆæœ¬å·ï¼ˆæ¨èï¼‰
./ä¸€é”®éƒ¨ç½²-prod.sh

# æ–¹å¼2: æŒ‡å®šç‰ˆæœ¬å·
./ä¸€é”®éƒ¨ç½²-prod.sh v1.2.3
```

---

## ğŸ”§ éƒ¨ç½²æµç¨‹è¯¦è§£

### ç¬¬ä¸€é˜¶æ®µï¼šæœ¬åœ°æ„å»º

```
1. æ£€æŸ¥åŸºç¡€é•œåƒï¼ˆnode:20-alpine, nginx:alpineï¼‰
2. æ„å»ºå‰ç«¯é•œåƒ (lzy-vue)
3. æ„å»ºåç«¯é•œåƒ (lzy-node)
4. æ„å»º PC ç®¡ç†åå°é•œåƒ (lzy-pc-admin)
5. æ¨é€é•œåƒåˆ°é˜¿é‡Œäº‘é•œåƒä»“åº“
```

**é˜¿é‡Œäº‘é•œåƒä»“åº“**:
```
ä»“åº“åœ°å€: crpi-3yk4ulmuej6mid83.cn-guangzhou.personal.cr.aliyuncs.com/lzy-docker-cangku
é•œåƒåˆ—è¡¨:
  - lzy-node:<ç‰ˆæœ¬>
  - lzy-vue:<ç‰ˆæœ¬>
  - lzy-pc-admin:<ç‰ˆæœ¬>
```

### ç¬¬äºŒé˜¶æ®µï¼šè¿œç¨‹éƒ¨ç½²

```
1. åŒæ­¥ SSL è¯ä¹¦åˆ°æœåŠ¡å™¨
2. æœåŠ¡å™¨ç™»å½•é˜¿é‡Œäº‘é•œåƒä»“åº“
3. åœæ­¢æ—§å®¹å™¨
4. æ‹‰å–æ–°é•œåƒ
5. å¯åŠ¨æ–°å®¹å™¨:
   - lzy_backend (ç«¯å£ 3000)
   - lzy_frontend (ç«¯å£ 8080)
   - lzy_pc_admin (ç«¯å£ 8081)
   - lzy_nginx (ç«¯å£ 80/443)
6. é…ç½®å®¹å™¨è‡ªå¯
7. å¥åº·æ£€æŸ¥
```

---

## ğŸ“ éƒ¨ç½²é…ç½®

### æœåŠ¡å™¨å®¹å™¨æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å‡†ç”Ÿäº§æœåŠ¡å™¨                      â”‚
â”‚                   8.138.192.106                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ lzy_nginx â”‚  â”‚lzy_backendâ”‚  â”‚lzy_frontendâ”‚        â”‚
â”‚  â”‚   :80    â”‚  â”‚  :3000   â”‚  â”‚   :8080   â”‚          â”‚
â”‚  â”‚   :443   â”‚  â”‚          â”‚  â”‚           â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜          â”‚
â”‚       â”‚              â”‚              â”‚               â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚              Docker Network                          â”‚
â”‚         (lzy_prod_network)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Nginx è·¯ç”±é…ç½®

| è®¿é—®è·¯å¾„ | ä»£ç†åˆ° | è¯´æ˜ |
|---------|-------|------|
| `/` | lzy_frontend:80 | å‰ç«¯é¡µé¢ |
| `/api/` | lzy_backend:3000 | åç«¯ API |
| `/pc-admin/` | lzy_pc_admin:8080 | PC ç®¡ç†åå° |
| `/pc-admin-api/` | lzy_backend:3000 | PC ç®¡ç†åå° API |

### SSL è¯ä¹¦é…ç½®

**è¯ä¹¦è·¯å¾„**: `/data/nginx-ssl-config/ssl/`

**æ”¯æŒåŸŸå**:
- xiaolu.lantel.net
- xiaolu.a.lantel.net
- ä½¿ç”¨é€šé…ç¬¦è¯ä¹¦ `*.lantel.net`

**è¯ä¹¦æ–‡ä»¶**:
```
/data/nginx-ssl-config/ssl/
â”œâ”€â”€ lantel.net.crt    # è¯ä¹¦æ–‡ä»¶
â””â”€â”€ lantel.net.key    # ç§é’¥æ–‡ä»¶
```

---

## âš™ï¸ ç¯å¢ƒå˜é‡é…ç½®

### åç«¯æœåŠ¡ç¯å¢ƒå˜é‡

éƒ¨ç½²æ—¶è‡ªåŠ¨åœ¨æœåŠ¡å™¨ä¸Šåˆ›å»º `/tmp/lzy-backend.env`ã€‚

**ç¯å¢ƒå˜é‡è¯´æ˜**:
```bash
NODE_ENV=production
PORT=3000
DB_HOST=rm-7xvqq66s5v7osdht5.mysql.rds.aliyuncs.com
DB_PORT=3306
DB_NAME=lzy_prod
DB_USER=lzy_Rds_Admin
DB_PASSWORD=${DB_PASSWORD}  # ä»ç¯å¢ƒå˜é‡è·å–ï¼Œä¸è¦ç¡¬ç¼–ç 
JWT_SECRET=${JWT_SECRET}     # ä»ç¯å¢ƒå˜é‡è·å–ï¼Œä¸è¦ç¡¬ç¼–ç 
JWT_EXPIRES_IN=7d
ALIYUN_ACCESS_KEY_ID=${ALIYUN_ACCESS_KEY_ID}       # ä»ç¯å¢ƒå˜é‡è·å–
ALIYUN_ACCESS_KEY_SECRET=${ALIYUN_ACCESS_KEY_SECRET}  # ä»ç¯å¢ƒå˜é‡è·å–
ALIYUN_OSS_BUCKET=lzy-gz-img-oss
ALIYUN_OSS_REGION=oss-cn-guangzhou
ALIYUN_OSS_INTERNAL=true
LOG_LEVEL=info
```

> âš ï¸ **å®‰å…¨æé†’**: æ‰€æœ‰å¯†ç ã€å¯†é’¥ç­‰æ•æ„Ÿä¿¡æ¯è¯·é€šè¿‡ç¯å¢ƒå˜é‡æˆ– `.env` æ–‡ä»¶é…ç½®ï¼Œä¸è¦ç›´æ¥å†™åœ¨æ–‡æ¡£æˆ–è„šæœ¬ä¸­ï¼

---

## ğŸ” éƒ¨ç½²åéªŒè¯

### 1. æ£€æŸ¥å®¹å™¨çŠ¶æ€

```bash
ssh lzy-pre-production "docker ps --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}'"
```

**é¢„æœŸè¾“å‡º**:
```
NAMES          STATUS         PORTS
lzy_nginx      Up 2 minutes   0.0.0.0:80->80/tcp, 0.0.0.0:443->443/tcp
lzy_frontend   Up 2 minutes   0.0.0.0:8080->80/tcp
lzy_backend    Up 2 minutes   0.0.0.0:3000->3000/tcp
lzy_pc_admin   Up 2 minutes   0.0.0.0:8081->8080/tcp
```

### 2. éªŒè¯ HTTPS è®¿é—®

```bash
# æµ‹è¯•å‰ç«¯
curl -I https://xiaolu-test.lantel.net

# æµ‹è¯• API
curl https://xiaolu-test.lantel.net/api/health

# æµ‹è¯• PC ç®¡ç†åå°
curl -I https://xiaolu-test.lantel.net/pc-admin/
```

### 3. æŸ¥çœ‹æ—¥å¿—

```bash
# å‰ç«¯æ—¥å¿—
ssh lzy-pre-production "docker logs lzy_frontend --tail 50"

# åç«¯æ—¥å¿—
ssh lzy-pre-production "docker logs lzy_backend --tail 50"

# Nginx æ—¥å¿—
ssh lzy-pre-production "docker logs lzy_nginx --tail 50"
```

---

## ğŸ› ï¸ æ•…éšœæ’é™¤

### é—®é¢˜1: SSH è¿æ¥å¤±è´¥

**ç—‡çŠ¶**: `æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ lzy-pre-production`

**è§£å†³**:
```bash
# 1. æ£€æŸ¥ SSH é…ç½®
cat ~/.ssh/config

# 2. æµ‹è¯•è¿æ¥
ssh -v lzy-pre-production

# 3. æ£€æŸ¥å¯†é’¥æƒé™
chmod 600 ~/.ssh/your_key_file
```

---

### é—®é¢˜2: é•œåƒæ¨é€å¤±è´¥

**ç—‡çŠ¶**: `ç™»å½•é˜¿é‡Œäº‘é•œåƒä»“åº“å¤±è´¥`

**è§£å†³**:
```bash
# 1. æ‰‹åŠ¨ç™»å½•æµ‹è¯•
docker login crpi-3yk4ulmuej6mid83.cn-guangzhou.personal.cr.aliyuncs.com \
  --username=zst13682229829

# 2. æ£€æŸ¥ç½‘ç»œ
ping crpi-3yk4ulmuej6mid83.cn-guangzhou.personal.cr.aliyuncs.com
```

---

### é—®é¢˜3: SSL è¯ä¹¦é”™è¯¯

**ç—‡çŠ¶**: `SSLè¯ä¹¦æ–‡ä»¶ä¸å­˜åœ¨`

**è§£å†³**:
```bash
# 1. æ£€æŸ¥æœ¬åœ°è¯ä¹¦
ls -la nginx-ssl-config/ssl/

# 2. å¦‚è¯ä¹¦ä¸å­˜åœ¨ï¼Œç”³è¯·æ–°è¯ä¹¦
./update-ssl-cert.sh

# 3. æ‰‹åŠ¨åŒæ­¥è¯ä¹¦
scp nginx-ssl-config/ssl/lantel.net.crt lzy-pre-production:/data/nginx-ssl-config/ssl/
scp nginx-ssl-config/ssl/lantel.net.key lzy-pre-production:/data/nginx-ssl-config/ssl/
```

---

### é—®é¢˜4: å®¹å™¨å¯åŠ¨å¤±è´¥

**ç—‡çŠ¶**: éƒ¨ç½²åå®¹å™¨çŠ¶æ€ä¸º `Exited`

**è§£å†³**:
```bash
# 1. æŸ¥çœ‹å®¹å™¨æ—¥å¿—
ssh lzy-pre-production "docker logs lzy_backend"

# 2. æ£€æŸ¥ç«¯å£å ç”¨
ssh lzy-pre-production "netstat -tlnp \| grep -E '80\|443\|3000\|8080\|8081'"

# 3. æ‰‹åŠ¨é‡å¯
ssh lzy-pre-production "docker restart lzy_backend lzy_frontend lzy_pc_admin lzy_nginx"
```

---

### é—®é¢˜5: HTTPS æ— æ³•è®¿é—®

**ç—‡çŠ¶**: æµè§ˆå™¨æ˜¾ç¤ºè¯ä¹¦é”™è¯¯

**è§£å†³**:
```bash
# 1. æ£€æŸ¥è¯ä¹¦æ˜¯å¦è¿‡æœŸ
openssl x509 -in nginx-ssl-config/ssl/lantel.net.crt -noout -dates

# 2. æ£€æŸ¥è¯ä¹¦æ˜¯å¦æ­£ç¡®éƒ¨ç½²
ssh lzy-pre-production "openssl x509 -in /data/nginx-ssl-config/ssl/lantel.net.crt -noout -subject"

# 3. é‡å¯ nginx
ssh lzy-pre-production "docker restart lzy_nginx"
```

---

## ğŸ“Š å›æ»šæ“ä½œ

å¦‚éœ€å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬ï¼š

```bash
ssh lzy-pre-production

# 1. æŸ¥çœ‹å†å²é•œåƒ
docker images \| grep lzy

# 2. åœæ­¢å½“å‰å®¹å™¨
docker stop lzy_frontend lzy_backend lzy_pc_admin lzy_nginx
docker rm lzy_frontend lzy_backend lzy_pc_admin lzy_nginx

# 3. ä½¿ç”¨æ—§ç‰ˆæœ¬é•œåƒå¯åŠ¨ï¼ˆæ›¿æ¢ <æ—§ç‰ˆæœ¬å·>ï¼‰
docker run -d --name lzy_backend --network lzy_prod_network -p 3000:3000 \
  --env-file /tmp/lzy-backend.env \
  crpi-3yk4ulmuej6mid83.cn-guangzhou.personal.cr.aliyuncs.com/lzy-docker-cangku/lzy-node:<æ—§ç‰ˆæœ¬å·>

# å…¶ä»–å®¹å™¨ç±»ä¼¼...
```

---

## ğŸ“ æ›´æ–°è®°å½•

| æ—¥æœŸ | å˜æ›´å†…å®¹ |
|------|----------|
| 2026-03-01 | åˆ›å»ºæ–‡æ¡£ï¼Œè®°å½•ä¸€é”®éƒ¨ç½²è„šæœ¬çš„ä½¿ç”¨æ–¹æ³• |
| 2026-03-01 | æ·»åŠ æ•…éšœæ’é™¤ç« èŠ‚ |

---

**ç»´æŠ¤è€…**: Claude Code  
**åˆ›å»ºæ—¥æœŸ**: 2026-03-01  
**æœ€åæ›´æ–°**: 2026-03-01
