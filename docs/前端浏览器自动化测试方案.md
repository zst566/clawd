# ğŸ­ å‰ç«¯æµè§ˆå™¨è‡ªåŠ¨åŒ–æµ‹è¯•æ–¹æ¡ˆ

## æ¦‚è¿°

ä½¿ç”¨ **Playwright** è¿›è¡Œæµè§ˆå™¨è‡ªåŠ¨åŒ–æµ‹è¯•ï¼Œå¯ä»¥ï¼š
- è‡ªåŠ¨æ‰“å¼€é¡µé¢å¹¶æˆªå›¾å¯¹æ¯”
- ç›‘æ§ç½‘ç»œè¯·æ±‚ï¼ˆAPI è°ƒç”¨ã€å“åº”æ—¶é—´ã€é”™è¯¯ï¼‰
- æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—ï¼ˆè­¦å‘Šã€é”™è¯¯ï¼‰
- æ¨¡æ‹Ÿç”¨æˆ·æ“ä½œï¼ˆç‚¹å‡»ã€è¾“å…¥ã€æ»šåŠ¨ï¼‰
- æ€§èƒ½åˆ†æï¼ˆåŠ è½½æ—¶é—´ã€èµ„æºå¤§å°ï¼‰

---

## 1. å®‰è£… Playwright

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•å®‰è£…
npm init playwright@latest

# æˆ–è€…åªåœ¨ mobile-h5 ç›®å½•å®‰è£…
cd apps/mobile-h5
npm install -D @playwright/test
npx playwright install
```

---

## 2. é…ç½®æ–‡ä»¶

### playwright.config.ts
```typescript
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost',  // å¼€å‘ç¯å¢ƒ
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
    video: 'retain-on-failure',
  },

  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'Mobile Chrome',
      use: { 
        ...devices['Pixel 5'],
        viewport: { width: 375, height: 812 },
      },
    },
    {
      name: 'Mobile Safari',
      use: { 
        ...devices['iPhone 12'],
        viewport: { width: 390, height: 844 },
      },
    },
  ],
});
```

---

## 3. æµ‹è¯•ç¤ºä¾‹

### 3.1 åŸºç¡€é¡µé¢æµ‹è¯•
```typescript
// e2e/home.spec.ts
import { test, expect } from '@playwright/test';

test('é¦–é¡µåŠ è½½æ­£å¸¸', async ({ page }) => {
  // æ‰“å¼€é¦–é¡µ
  await page.goto('/');
  
  // æ£€æŸ¥é¡µé¢æ ‡é¢˜
  await expect(page).toHaveTitle(/ä¿¡å®œæ–‡æ—…/);
  
  // æ£€æŸ¥å…³é”®å…ƒç´ å­˜åœ¨
  await expect(page.locator('.home-glass')).toBeVisible();
  
  // æˆªå›¾ä¿å­˜
  await page.screenshot({ path: 'screenshots/home.png', fullPage: true });
});
```

### 3.2 ç½‘ç»œè¯·æ±‚ç›‘æ§
```typescript
// e2e/api-monitoring.spec.ts
import { test, expect } from '@playwright/test';

test('ç›‘æ§ API è¯·æ±‚', async ({ page }) => {
  const apiRequests = [];
  const apiResponses = [];
  
  // ç›‘å¬æ‰€æœ‰è¯·æ±‚
  page.on('request', request => {
    if (request.url().includes('/api/')) {
      apiRequests.push({
        url: request.url(),
        method: request.method(),
        headers: request.headers(),
        timestamp: new Date().toISOString(),
      });
    }
  });
  
  // ç›‘å¬æ‰€æœ‰å“åº”
  page.on('response', async response => {
    if (response.url().includes('/api/')) {
      const body = await response.text().catch(() => null);
      apiResponses.push({
        url: response.url(),
        status: response.status(),
        statusText: response.statusText(),
        body: body,
        timestamp: new Date().toISOString(),
      });
    }
  });
  
  // æ‰“å¼€é¡µé¢
  await page.goto('/');
  
  // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆ
  await page.waitForLoadState('networkidle');
  
  // è¾“å‡ºç›‘æ§ç»“æœ
  console.log('API è¯·æ±‚:', JSON.stringify(apiRequests, null, 2));
  console.log('API å“åº”:', JSON.stringify(apiResponses, null, 2));
  
  // æ£€æŸ¥æ˜¯å¦æœ‰ 500 é”™è¯¯
  const failedResponses = apiResponses.filter(r => r.status >= 500);
  expect(failedResponses).toHaveLength(0);
});
```

### 3.3 æ§åˆ¶å°é”™è¯¯æ£€æŸ¥
```typescript
// e2e/console-check.spec.ts
import { test, expect } from '@playwright/test';

test('æ£€æŸ¥æ§åˆ¶å°é”™è¯¯', async ({ page }) => {
  const consoleErrors = [];
  const consoleWarnings = [];
  
  // ç›‘å¬æ§åˆ¶å°æ¶ˆæ¯
  page.on('console', msg => {
    const text = msg.text();
    const type = msg.type();
    
    if (type === 'error') {
      consoleErrors.push({
        text,
        location: msg.location(),
        timestamp: new Date().toISOString(),
      });
    } else if (type === 'warning') {
      consoleWarnings.push({
        text,
        location: msg.location(),
        timestamp: new Date().toISOString(),
      });
    }
  });
  
  // ç›‘å¬é¡µé¢é”™è¯¯
  page.on('pageerror', error => {
    consoleErrors.push({
      text: error.message,
      stack: error.stack,
      timestamp: new Date().toISOString(),
    });
  });
  
  // æ‰“å¼€é¡µé¢å¹¶æ‰§è¡Œæ“ä½œ
  await page.goto('/');
  await page.waitForLoadState('networkidle');
  
  // æ»šåŠ¨é¡µé¢è§¦å‘æ‡’åŠ è½½
  await page.evaluate(() => window.scrollTo(0, document.body.scrollHeight));
  await page.waitForTimeout(2000);
  
  // è¾“å‡ºç»“æœ
  console.log('æ§åˆ¶å°é”™è¯¯:', consoleErrors);
  console.log('æ§åˆ¶å°è­¦å‘Š:', consoleWarnings);
  
  // æ–­è¨€æ²¡æœ‰é”™è¯¯
  expect(consoleErrors).toHaveLength(0);
});
```

### 3.4 æ€§èƒ½æµ‹è¯•
```typescript
// e2e/performance.spec.ts
import { test, expect } from '@playwright/test';

test('é¡µé¢æ€§èƒ½æµ‹è¯•', async ({ page }) => {
  // è®°å½•æ€§èƒ½æŒ‡æ ‡
  const performanceMetrics = await page.evaluate(() => {
    const timing = performance.timing;
    return {
      // é¡µé¢åŠ è½½æ—¶é—´
      loadTime: timing.loadEventEnd - timing.navigationStart,
      // DOM å‡†å¤‡æ—¶é—´
      domReady: timing.domContentLoadedEventEnd - timing.navigationStart,
      // é¦–å­—èŠ‚æ—¶é—´
      ttfb: timing.responseStart - timing.navigationStart,
      // èµ„æºæ•°é‡
      resourceCount: performance.getEntriesByType('resource').length,
    };
  });
  
  console.log('æ€§èƒ½æŒ‡æ ‡:', performanceMetrics);
  
  // æ£€æŸ¥èµ„æºåŠ è½½
  const resources = await page.evaluate(() => {
    return performance.getEntriesByType('resource').map(r => ({
      name: r.name,
      duration: r.duration,
      size: (r as any).transferSize || 0,
    }));
  });
  
  // æ‰¾å‡ºåŠ è½½æ…¢çš„èµ„æº (>1s)
  const slowResources = resources.filter(r => r.duration > 1000);
  console.log('æ…¢èµ„æº:', slowResources);
  
  // æ–­è¨€åŠ è½½æ—¶é—´
  expect(performanceMetrics.loadTime).toBeLessThan(5000); // 5ç§’å†…
});
```

### 3.5 ç”¨æˆ·æµç¨‹æµ‹è¯•
```typescript
// e2e/user-flow.spec.ts
import { test, expect } from '@playwright/test';

test('ç”¨æˆ·ç™»å½•æµç¨‹', async ({ page }) => {
  // æ‰“å¼€ç™»å½•é¡µ
  await page.goto('/login');
  
  // è¾“å…¥æ‰‹æœºå·
  await page.fill('[placeholder="è¯·è¾“å…¥æ‰‹æœºå·"]', '13800000000');
  
  // è¾“å…¥å¯†ç 
  await page.fill('[placeholder="è¯·è¾“å…¥å¯†ç "]', '123456');
  
  // ç‚¹å‡»ç™»å½•
  await page.click('button:has-text("ç™»å½•")');
  
  // ç­‰å¾…è·³è½¬
  await page.waitForURL('/');
  
  // æ£€æŸ¥ç™»å½•æˆåŠŸ
  await expect(page.locator('.user-info')).toContainText('13800000000');
});

test('æ‹¼è½¦ä¸‹å•æµç¨‹', async ({ page }) => {
  // ç™»å½•
  await page.goto('/login');
  await page.fill('[placeholder="è¯·è¾“å…¥æ‰‹æœºå·"]', '13800000000');
  await page.fill('[placeholder="è¯·è¾“å…¥å¯†ç "]', '123456');
  await page.click('button:has-text("ç™»å½•")');
  
  // è¿›å…¥æ‹¼è½¦é¡µé¢
  await page.goto('/carpool/create');
  
  // é€‰æ‹©èµ·ç‚¹
  await page.click('[placeholder="é€‰æ‹©ä¸Šè½¦ç‚¹"]');
  await page.click('.location-item:has-text("é«˜é“ç«™")');
  
  // é€‰æ‹©ç»ˆç‚¹
  await page.click('[placeholder="é€‰æ‹©ç›®çš„åœ°"]');
  await page.click('.location-item:has-text("å¸‚åŒº")');
  
  // é€‰æ‹©æ—¶é—´
  await page.click('[placeholder="é€‰æ‹©å‡ºå‘æ—¶é—´"]');
  await page.click('.time-item:has-text("14:00")');
  
  // æäº¤è®¢å•
  await page.click('button:has-text("ç«‹å³é¢„çº¦")');
  
  // ç­‰å¾…è®¢å•åˆ›å»ºæˆåŠŸ
  await expect(page.locator('.success-message')).toBeVisible();
});
```

---

## 4. å®ç”¨å·¥å…·è„šæœ¬

### æ‰¹é‡æˆªå›¾å¯¹æ¯”
```typescript
// e2e/screenshot-all.spec.ts
import { test, expect } from '@playwright/test';

const pages = [
  { path: '/', name: 'home' },
  { path: '/login', name: 'login' },
  { path: '/carpool/create', name: 'carpool-create' },
  { path: '/carpool/my-carpools', name: 'carpool-list' },
  { path: '/attractions', name: 'attractions' },
  { path: '/homestays', name: 'homestays' },
  { path: '/profile', name: 'profile' },
];

for (const { path, name } of pages) {
  test(`æˆªå›¾: ${name}`, async ({ page }) => {
    await page.goto(path);
    await page.waitForLoadState('networkidle');
    
    // ç­‰å¾…åŠ¨ç”»å®Œæˆ
    await page.waitForTimeout(1000);
    
    // æˆªå›¾
    await page.screenshot({
      path: `screenshots/${name}.png`,
      fullPage: true,
    });
  });
}
```

### API å“åº”æ—¶é—´æµ‹è¯•
```typescript
// e2e/api-performance.spec.ts
import { test, expect } from '@playwright/test';

test('API å“åº”æ—¶é—´æ£€æŸ¥', async ({ page }) => {
  const apiTimings = [];
  
  page.on('response', async response => {
    if (response.url().includes('/api/')) {
      const timing = await response.request().timing();
      apiTimings.push({
        url: response.url(),
        status: response.status(),
        responseTime: timing.responseEnd - timing.startTime,
      });
    }
  });
  
  // æ‰“å¼€é¡µé¢è§¦å‘ API è°ƒç”¨
  await page.goto('/');
  await page.waitForLoadState('networkidle');
  
  // åˆ†æç»“æœ
  console.table(apiTimings);
  
  // æ£€æŸ¥æ…¢æ¥å£ (>2s)
  const slowApis = apiTimings.filter(t => t.responseTime > 2000);
  if (slowApis.length > 0) {
    console.warn('æ…¢æ¥å£è­¦å‘Š:', slowApis);
  }
  
  // æ–­è¨€
  expect(slowApis).toHaveLength(0);
});
```

---

## 5. è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
npx playwright test

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
npx playwright test e2e/home.spec.ts

# è¿è¡Œå¹¶ç”ŸæˆæŠ¥å‘Š
npx playwright test --reporter=html

# è°ƒè¯•æ¨¡å¼ï¼ˆæœ‰ç•Œé¢ï¼‰
npx playwright test --headed

# åªè¿è¡Œç§»åŠ¨ç«¯æµ‹è¯•
npx playwright test --project="Mobile Chrome"

# å½•åˆ¶æ–°æµ‹è¯•
npx playwright codegen http://localhost
```

---

## 6. ç›®å½•ç»“æ„å»ºè®®

```
apps/mobile-h5/
â”œâ”€â”€ e2e/                          # æµ‹è¯•æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ fixtures/                 # æµ‹è¯•æ•°æ®
â”‚   â”œâ”€â”€ utils/                    # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ api-monitor.ts        # API ç›‘æ§å·¥å…·
â”‚   â”‚   â”œâ”€â”€ console-checker.ts    # æ§åˆ¶å°æ£€æŸ¥å·¥å…·
â”‚   â”‚   â””â”€â”€ performance.ts        # æ€§èƒ½æµ‹è¯•å·¥å…·
â”‚   â”œâ”€â”€ specs/                    # æµ‹è¯•ç”¨ä¾‹
â”‚   â”‚   â”œâ”€â”€ home.spec.ts
â”‚   â”‚   â”œâ”€â”€ login.spec.ts
â”‚   â”‚   â”œâ”€â”€ carpool.spec.ts
â”‚   â”‚   â””â”€â”€ api-monitoring.spec.ts
â”‚   â””â”€â”€ screenshots/              # æˆªå›¾ä¿å­˜ç›®å½•
â”œâ”€â”€ playwright.config.ts          # Playwright é…ç½®
â””â”€â”€ package.json
```

---

## 7. CI/CD é›†æˆ

### GitHub Actions ç¤ºä¾‹
```yaml
# .github/workflows/playwright.yml
name: Playwright Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-node@v3
      with:
        node-version: 20
    - name: Install dependencies
      run: npm ci
    - name: Install Playwright
      run: npx playwright install --with-deps
    - name: Run Playwright tests
      run: npx playwright test
    - uses: actions/upload-artifact@v3
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30
```

---

## 8. å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

| å‘½ä»¤ | è¯´æ˜ |
|------|------|
| `npx playwright test` | è¿è¡Œæ‰€æœ‰æµ‹è¯• |
| `npx playwright test --ui` | å›¾å½¢ç•Œé¢è¿è¡Œ |
| `npx playwright codegen` | å½•åˆ¶æµ‹è¯•è„šæœ¬ |
| `npx playwright show-report` | æŸ¥çœ‹æµ‹è¯•æŠ¥å‘Š |
| `npx playwright install` | å®‰è£…æµè§ˆå™¨ |
| `npx playwright trace show` | æŸ¥çœ‹è¿½è¸ªè®°å½• |

---

éœ€è¦æˆ‘å¸®ä½ å®‰è£…é…ç½® Playwrightï¼Œæˆ–è€…ç¼–å†™å…·ä½“çš„æµ‹è¯•è„šæœ¬å—ï¼Ÿ
