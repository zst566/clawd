# 🚀 小程序生产环境部署检查清单

> **用途**: 茂名文旅小程序每次正式环境部署前的标准检查流程
> **创建时间**: 2026-02-13
> **更新记录**: 2026-02-13 修正数据库连接为阿里云RDS域名，移除Redis

---

## ✅ 部署前必查项

### 1. 小程序端配置
- [ ] **正式环境域名**
  - 小程序后台配置的 request/websocket/upload/download 域名已切换为正式域名
  - 域名指向负载均衡或正式环境服务器
  - 检查位置: 微信小程序后台 → 开发管理 → 开发设置 → 服务器域名

- [ ] **业务域名**（如有web-view）
  - web-view 业务域名已配置为正式环境地址

- [ ] **小程序版本**
  - 代码已提交到生产分支（如 `main` / `production`）
  - 版本号已更新

---

### 2. 后端服务配置
- [ ] **数据库连接**
  - 确认连接的是生产数据库
  - 生产库: 阿里云RDS域名（如 `rm-xxxx.mysql.rds.aliyuncs.com`）
  - 数据库名: `wanda_platform`
  - 检查位置: 容器环境变量 / 配置文件

- [ ] **OSS/存储配置**
  - 阿里云OSS Bucket指向生产环境 (`hxcm-oss`)
  - AccessKey 是生产环境凭证

---

### 3. 第三方服务配置
- [ ] **微信支付**
  - mchid、appid、APIv3密钥是正式环境
  - 支付回调地址是正式环境域名

- [ ] **地图服务**（如腾讯地图/高德地图）
  - API Key 是正式环境Key

- [ ] **地图服务 - 腾讯地图**
  - API Key 已配置: `TENCENT_MAP_KEY`
  - 检查位置: `apps/backend/.env.production`
  - 检查部署脚本: `scripts/deploy-backend.sh` 中是否正确注入环境变量
  - 验证命令（部署后）: `docker exec xinyi-wenlu-backend env | grep TENCENT_MAP_KEY`

- [ ] **短信服务**
  - 短信模板ID是正式环境模板

- [ ] **其他第三方SDK**
  - 所有第三方服务的appid/key都切换到正式环境

---

### 4. 部署执行
- [ ] **镜像制作**
  - 后端代码已构建为Docker镜像
  - 镜像标签规范（如 `v1.2.3-20260213`）

- [ ] **镜像推送**
  - 自定义镜像已推送到正式环境服务器/镜像仓库

- [ ] **准生产环境验证**
  - 在准生产环境（对接正式库的版本）测试通过
  - 关键业务流程验证：登录、支付、数据加载

---

### 5. 发布后检查
- [ ] **小程序审核**
  - 已提交微信审核（如涉及敏感功能）
  - 审核通过后发布

- [ ] **线上验证**
  - 扫码进入小程序，测试核心功能
  - 检查网络请求是否正常（域名正确）
  - 检查数据是否正确（确认是生产库数据）

- [ ] **腾讯地图 Key 验证**
  - 服务器执行: `docker exec xinyi-wenlu-backend env | grep TENCENT_MAP_KEY`
  - 确认输出: `TENCENT_MAP_KEY=RNYBZ-VMELW-J5HRP-YAS4F-5OMKH-35BAE`
  - 如为空，检查部署脚本是否正确注入

- [ ] **日志监控**
  - 生产环境日志无异常报错
  - 监控告警配置正常

---

## 📋 快速核对表（每次部署必看）

| 检查项 | 检查位置 | 期望值 |
|--------|----------|--------|
| 小程序域名 | 微信后台 | 正式域名 |
| 后端数据库 | 容器环境变量 | 阿里云RDS域名 |
| OSS Bucket | 后端配置 | `hxcm-oss` |
| 腾讯地图Key | 后端配置 | `RNYBZ-VMELW-J5HRP-YAS4F-5OMKH-35BAE` |
| 微信支付 | 后端配置 | 正式商户号 |
| 日志级别 | 后端配置 | `error` 或 `warn` |

---

## ⚠️ 常见遗漏点

1. **只改了小程序域名，忘记改后端库** → 导致测试数据混入生产库，或生产数据读取失败
2. **OSS配置未切** → 图片上传到测试bucket，正式环境看不到
3. **腾讯地图Key未注入** → 拼车路线计算使用默认值（30分钟/15公里），影响预估时间准确性
4. **支付回调地址是测试环境** → 用户支付成功但状态不更新
5. **日志级别还是debug** → 日志暴涨，影响性能

---

## 🔄 部署流程图

```
1. 开发环境开发测试
   ↓
2. 确认以上所有检查项
   ↓
3. 提交小程序代码（等待审核）
   ↓
4. 后端构建镜像 → 推送准生产
   ↓
5. 准生产环境测试（正式库）
   ↓
6. 测试通过 → 推送正式环境
   ↓
7. 小程序审核通过 → 发布
   ↓
8. 线上验证
```

---

## 📁 相关文件位置

- 小程序配置: `apps/miniprogram/`
- 后端环境变量: `apps/backend/.env.production`
- 生产服务器: `112.74.36.81` (root/nrftI5r4ag9qAGvk)
- 部署目录: `/app/xinyi-wenlu/`

---

*下次部署时，我会自动提醒你对照此清单检查* ✅
