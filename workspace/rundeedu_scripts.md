# 润德教育 - 常用脚本和SQL

> 记录润德教育项目中常用的脚本和SQL，方便后续复用
> 最后更新: 2026-02-01

---

## 核对脚本

### 财务收入核对脚本
- **名称**: 财务收入核对脚本
- **路径**: `src/scripts/verify_financial_records.py`
- **功能**: 将财务收入数据与清洗库数据进行对比
- **使用命令**:
  ```bash
  python src/scripts/verify_financial_records.py \
    --excel "/Volumes/SanDisk2T/dv-codeBase/RunDeEdu/docs/待核对的2512收入和退款明细/202512微信、支付宝后台流水.xlsx" \
    --sheet "三方平台流水" \
    --output "/Volumes/SanDisk2T/dv-codeBase/RunDeEdu/docs/待核对的2512收入和退款明细/compare-result-12.xlsx"
  ```
- **用途**: 核对财务收入和退款数据与清洗库中的订单记录是否一致

---

## SQL查询脚本

### 僵尸订单检查SQL
- **名称**: 僵尸订单检查SQL
- **路径**: `docs/查询sql/僵尸订单_V3.sql`
- **功能**: 找出所有 un_confirmed_amount > 0 且最新记录的 date < 2025-12-01 的僵尸订单
- **用途**: 检查长期无更新的订单，这些订单会导致月度余额差异
- **统计数据**:
  - 2022年之前有余额的僵尸订单: 6,102个
  - 2023年之前有余额的僵尸订单: 38,372个
  - 2024年之前有余额的僵尸订单: 248,211个

### 订单收入平衡校验SQL
- **名称**: 订单收入平衡校验SQL
- **路径**: `docs/查询sql/订单收入平衡校验.sql`
- **功能**: 检验收入摊销主表每个订单的跨月平衡
- **验证公式**: 上期期末 + 本期实收 - 本期确认 = 本期期末
- **用途**: 验证订单链的平衡性

### 2023年12月有余额2024年1月无记录订单SQL
- **名称**: 跨月差异分析SQL
- **路径**: `docs/查询sql/2023年12月有余额2024年1月无记录订单.sql`
- **功能**: 找出2023年12月有余额但2024年1月没有记录的订单
- **用途**: 分析跨月验证差异的来源
- **统计数据**: 36,181个订单，总余额 385,562.26元

---

## 数据库连接配置

| 环境 | Host | Port | Database |
|------|------|------|----------|
| 生产环境(新) | rm-wz98c09t2n18wopu89o.mysql.rds.aliyuncs.com | 3399 | runde_center_revenue_recognition_db |

---

## 常见问题

### 僵尸订单
- **定义**: 订单的最新记录 `un_confirmed_amount = 0` 或日期较久远（< 2025-12-01）
- **影响**: 导致每个月的月末余额产生差异，无法通过月度订单平衡检查
- **解决方案**: 需要补上缺失的月份数据，使订单链完整

---

## 业务知识

### 延期服务 vs 继续服务

| 类型 | 是否产生新订单 | 特点 |
|------|---------------|------|
| **延期服务** | ❌ 否 | 在原3.0订单里直接产生服务，不产生新订单 |
| **继续服务** | ❌ 否 | 不会产生新订单或子项，在原订单里继续服务 |

**说明**：
- 延期服务：服务时间顺延，不产生新订单或子项
- 继续服务：在原订单里继续服务，不会产生新订单子项
- 3.0系统中这两类售后都**不产生新订单**

**影响**：理解这两类服务的特点有助于分析订单链的完整性和收入确认逻辑。
